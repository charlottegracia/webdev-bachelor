name: CI/CD Pipeline

on:
  push:
    branches:
      - dev
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Setup PHP 8.2 for Laravel Backend
      - name: Set up PHP 8.2
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      # Install Composer dependencies for Laravel Backend
      - name: Install Composer dependencies
        run: |
          cd backend
          composer install --no-interaction

      # Setup and run Nuxt 3 (Frontend) tests only if test files exist
      - name: Run Nuxt 3 Tests if Present
        run: |
          if [ "$(find frontend/tests -name '*.test.js' -o -name '*.spec.js')" ]; then
            cd frontend
            npm install
            npm run test
          else
            echo "No frontend tests found. Skipping frontend tests."
          fi

      # Set the environment for Laravel to use in-memory SQLite database for testing
      - name: Set up Laravel Environment for Testing
        run: |
          cd backend
          echo "DB_CONNECTION=sqlite" >> .env.testing
          echo "DB_DATABASE=:memory:" >> .env.testing
          echo "CACHE_DRIVER=array" >> .env.testing  # Optional, for faster tests

      # Run Laravel Migrations and Tests (use in-memory SQLite)
      - name: Run Laravel Migrations and Tests if Present
        run: |
          cd backend
          # Run migrations for the in-memory SQLite database
          php artisan migrate --database=sqlite --force
          # Run tests if present
          php artisan test --env=testing
